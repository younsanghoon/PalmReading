<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="description" content="AI와 심리학으로 알아보는 나의 진짜 성격 - MBTI, 에겐-테토, 동물상, 손금 테스트">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="성격테스트">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="stylesheet" href="/camera-capture.css">
    <title>성격 테스트 센터 - AI 성격 분석</title>
    <script async src="https://pagead.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6706508307630636" crossorigin="anonymous"></script>
    <script type="text/javascript">
      // GitHub Pages에서 SPA 라우팅을 위한 리다이렉트 처리
      (function(l) {
        console.log("[SPA Redirect] Checking for redirect");
        console.log("[SPA Redirect] Full URL:", l.href);
        console.log("[SPA Redirect] Protocol:", l.protocol);
        console.log("[SPA Redirect] Host:", l.host);
        console.log("[SPA Redirect] Pathname:", l.pathname);
        console.log("[SPA Redirect] Search:", l.search);
        console.log("[SPA Redirect] Hash:", l.hash);
        
        // GitHub Pages 404 redirect 처리
        if (l.search[1] === '/' ) {
          var decoded = l.search.slice(1).split('&').map(function(s) { 
            return s.replace(/~and~/g, '&')
          }).join('?');
          console.log("[SPA Redirect] Redirecting to:", l.pathname.slice(0, -1) + decoded + l.hash);
          window.history.replaceState(null, null,
              l.pathname.slice(0, -1) + decoded + l.hash
          );
        }
        
        // SPA 라우트 처리
        var pathname = l.pathname;
        console.log("[SPA Redirect] Current pathname:", pathname);
        
        // 개발 환경 확인
        var isDev = l.hostname === 'localhost' || l.hostname === '127.0.0.1';
        console.log("[SPA Redirect] Environment:", isDev ? "development" : "production");
        console.log("[SPA Redirect] Hostname:", l.hostname);
        
        // 프로덕션 환경에서 base path 제거
        if (!isDev && pathname.startsWith('/PalmReading')) {
          var newPath = pathname.replace('/PalmReading', '') || '/';
          console.log("[SPA Redirect] Removing base path, new path:", newPath);
          window.history.replaceState(null, null, newPath + l.search + l.hash);
        }
        
        // SPA 라우트 목록
        var spaRoutes = ['/', '/animal-test', '/mbti-test', '/enneagram-test', '/palm-test', 
                         '/privacy-policy', '/terms-of-service', '/contact'];
        console.log("[SPA Redirect] Available SPA routes:", JSON.stringify(spaRoutes));
        
        // 현재 경로가 SPA 라우트인지 확인
        var normalizedPath = pathname;
        if (!isDev && pathname.startsWith('/PalmReading')) {
          normalizedPath = pathname.replace('/PalmReading', '') || '/';
        }
        
        console.log("[SPA Redirect] Normalized path:", normalizedPath);
        if (spaRoutes.includes(normalizedPath)) {
          console.log("[SPA Redirect] Current path is a valid SPA route");
        } else {
          console.log("[SPA Redirect] Current path is not a recognized SPA route, might fallback to 404");
          console.log("[SPA Redirect] Path comparison results:");
          spaRoutes.forEach(function(route) {
            console.log("[SPA Redirect] - Comparing '" + normalizedPath + "' with '" + route + "':", normalizedPath === route);
          });
        }
        
        // 전역 라우팅 디버그 객체 생성
        window.__spaDebug = {
          originalUrl: l.href,
          pathname: pathname,
          normalizedPath: normalizedPath,
          isDev: isDev,
          spaRoutes: spaRoutes,
          isValidRoute: spaRoutes.includes(normalizedPath),
          logState: function() {
            console.log("[SPA Debug] Current state:", {
              url: window.location.href,
              pathname: window.location.pathname,
              normalizedPath: this.normalizedPath,
              isDev: this.isDev,
              isValidRoute: spaRoutes.includes(window.location.pathname)
            });
          }
        };
        
        console.log("[SPA Redirect] Debug object created, access via window.__spaDebug");
      }(window.location))
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
    <script src="/camera-capture.js"></script>
    <script>
      // 페이지 로드 후 SPA 라우팅 초기화
      document.addEventListener('DOMContentLoaded', function() {
        console.log("[SPA Init] DOM content loaded");
        
        // 현재 경로 확인
        var currentPath = window.location.pathname;
        console.log("[SPA Init] Current path:", currentPath);
        console.log("[SPA Init] Full URL:", window.location.href);
        
        // 개발 환경 확인
        var isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        console.log("[SPA Init] Environment:", isDev ? "development" : "production");
        console.log("[SPA Init] Hostname:", window.location.hostname);
        
        // SPA 라우트 목록
        var spaRoutes = ['/', '/animal-test', '/mbti-test', '/enneagram-test', '/palm-test', 
                         '/privacy-policy', '/terms-of-service', '/contact'];
        
        // 전역 변수로 저장
        window.__SPA_ROUTES = spaRoutes;
        window.__IS_DEV = isDev;
        
        console.log("[SPA Init] Routes registered:", JSON.stringify(spaRoutes));
        
        // 현재 경로가 유효한 SPA 라우트인지 확인
        var isValidRoute = spaRoutes.includes(currentPath);
        console.log("[SPA Init] Current path is valid SPA route:", isValidRoute);
        
        if (!isValidRoute) {
          console.log("[SPA Init] Path comparison results:");
          spaRoutes.forEach(function(route) {
            console.log("[SPA Init] - Comparing '" + currentPath + "' with '" + route + "':", currentPath === route);
          });
          
          // 경로 정규화 시도
          var normalizedPath = currentPath;
          if (normalizedPath.endsWith('/')) {
            normalizedPath = normalizedPath.slice(0, -1);
          }
          if (!normalizedPath.startsWith('/')) {
            normalizedPath = '/' + normalizedPath;
          }
          
          console.log("[SPA Init] Normalized path:", normalizedPath);
          isValidRoute = spaRoutes.includes(normalizedPath);
          console.log("[SPA Init] Normalized path is valid SPA route:", isValidRoute);
          
          if (isValidRoute) {
            console.log("[SPA Init] Redirecting to normalized path:", normalizedPath);
            window.history.replaceState(null, null, normalizedPath);
          }
        }
        
        // 링크 클릭 이벤트 처리
        document.body.addEventListener('click', function(e) {
          // 링크 클릭 확인
          var target = e.target;
          while (target && target.tagName !== 'A') {
            target = target.parentNode;
            if (!target || target === document.body) break;
          }
          
          // 링크가 아니면 무시
          if (!target || target.tagName !== 'A') return;
          
          // 외부 링크면 무시
          var href = target.getAttribute('href');
          if (!href || href.startsWith('http') || href.startsWith('//')) return;
          
          console.log("[SPA Init] Link clicked:", href);
          console.log("[SPA Init] Target element:", target.outerHTML);
          
          // SPA 라우트면 이벤트 취소하고 직접 처리
          if (spaRoutes.includes(href)) {
            e.preventDefault();
            console.log("[SPA Init] Handling SPA route:", href);
            
            try {
              // 디버그 라우터가 있으면 사용
              if (window.__debugRouter && typeof window.__debugRouter.goTo === 'function') {
                console.log("[SPA Init] Using debug router for navigation");
                window.__debugRouter.goTo(href);
              } else {
                // 직접 URL 변경
                console.log("[SPA Init] Using direct URL change");
                window.location.href = href;
              }
            } catch (error) {
              console.error("[SPA Init] Navigation error:", error);
              // 오류 발생 시 직접 URL 변경
              window.location.href = href;
            }
          } else {
            console.log("[SPA Init] Not a SPA route, allowing default navigation");
          }
        });
        
        // 라우팅 디버그 유틸리티 추가
        window.__spaRouteDebug = {
          routes: spaRoutes,
          checkRoute: function(path) {
            var normalizedPath = path;
            if (!normalizedPath.startsWith('/')) {
              normalizedPath = '/' + normalizedPath;
            }
            console.log("[SPA Debug] Checking route:", normalizedPath);
            var isValid = spaRoutes.includes(normalizedPath);
            console.log("[SPA Debug] Is valid route:", isValid);
            return isValid;
          },
          navigateTo: function(path) {
            var normalizedPath = path;
            if (!normalizedPath.startsWith('/')) {
              normalizedPath = '/' + normalizedPath;
            }
            console.log("[SPA Debug] Manual navigation to:", normalizedPath);
            
            if (window.__debugRouter && typeof window.__debugRouter.goTo === 'function') {
              window.__debugRouter.goTo(normalizedPath);
            } else {
              window.location.href = normalizedPath;
            }
          },
          logState: function() {
            console.log("[SPA Debug] Current state:", {
              url: window.location.href,
              pathname: window.location.pathname,
              isValidRoute: spaRoutes.includes(window.location.pathname),
              availableRoutes: spaRoutes
            });
          }
        };
        
        console.log("[SPA Init] Route debug utility available at window.__spaRouteDebug");
      });
    </script>
  </body>
</html>